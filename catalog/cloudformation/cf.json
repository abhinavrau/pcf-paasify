{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Deploys PCF",
   "Parameters":{
      "EnvName":{
         "Description":"Environment name",
         "Type":"String"
      },
      "DnsSuffix":{
         "Description":"DNS suffix",
         "Type":"String"
      },
      "PivnetToken":{
         "Description":"Pivnet Token to download tiles",
         "Type":"String"
      }
   },
   "Resources":{
      "S3StateAndSoftware":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Fn::Join":[
                  ".",
                  [
                     {
                        "Ref":"EnvName"
                     },
                     {
                        "Ref":"AWS::Region"
                     },
                     {
                        "Ref":"AWS::AccountId"
                     },
                     "paasify-state"
                  ]
               ]
            }
         }
      },
      "Adminrole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":{
               "Fn::Join":[
                  ".",
                  [
                     {
                        "Ref":"AWS::StackName"
                     },
                     {
                        "Ref":"AWS::Region"
                     },
                     "paasify-codebuild"
                  ]
               ]
            },
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codebuild.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"adminaccess",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Action":"*",
                           "Effect":"Allow",
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "BuildProject":{
         "Type":"AWS::CodeBuild::Project",
         "Properties":{
            "Name":{
               "Fn::Join":[
                  "_",
                  [
                     "paasify",
                     {
                        "Ref":"EnvName"
                     },
                     {
                        "Ref":"AWS::Region"
                     },
                     "build"
                  ]
               ]
            },
            "Description":"Deploy PCF",
            "ServiceRole":{
               "Ref":"Adminrole"
            },
            "Artifacts":{
               "Type":"no_artifacts"
            },
            "Environment":{
               "Type":"LINUX_CONTAINER",
               "ComputeType":"BUILD_GENERAL1_SMALL",
               "Image":"aws/codebuild/docker:17.09.0",
               "EnvironmentVariables":[
                  {
                     "Name":"region",
                     "Value":{
                        "Ref":"AWS::Region"
                     }
                  },
                  {
                     "Name":"account",
                     "Value":{
                        "Ref":"AWS::AccountId"
                     }
                  },
                  {
                     "Name":"env",
                     "Value":{
                        "Ref":"EnvName"
                     }
                  },
                  {
                     "Name":"dns_suffix",
                     "Value":{
                        "Ref":"DnsSuffix"
                     }
                  },
                  {
                     "Name":"pivnet_token",
                     "Value":{
                        "Ref":"PivnetToken"
                     }
                  }
               ]
            },
            "Source":{
               "Location":"https://github.com/nthomson-pivotal/pcf-paasify",
               "Type":"GITHUB",
               "BuildSpec": "catalog/codebuild/buildspec.yml"
            },
            "TimeoutInMinutes":10,
            "Tags":[
               {
                  "Key":"Project",
                  "Value":"Run Terraform From CodeBuild"
               }
            ]
         }
      }
   }
}
